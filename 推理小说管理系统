/**
 * 定义一个侦探小说管理系统，实现基本的书籍插入，修改，删除和展示所有小说的操作。存放的基本信息是书籍名，作者以及价格。
 */

import java.io.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

public class Main {

    private static List<Book> LIST;

    public static void main(String[] args){
        loadBooks();
        Scanner scanner = new Scanner(System.in);
        while(true){
            System.out.println("========== 侦探小说管理系统 ==========");
            System.out.println("1.插入信息");
            System.out.println("2.修改信息");
            System.out.println("3.查询图书列表");
            System.out.println("4.删除图书");
            System.out.println("（按任意键退出系统）");
            String str = scanner.nextLine();
            switch (str){
                case "1":
                    insertBook(scanner);//插入图书信息
                    break;
                case "2":
                    modifyBook(scanner);//修改图书信息
                    break;
                case "3":
                    showBooks();//展示所有图书列表
                    System.out.println("请按任意键回到侦探小说管理系统");
                    scanner.nextLine();
                    break;
                case "4":
                    deleteBook(scanner);//删除某一图书
                    break;
                default:
                    saveBooks();//保存书籍信息
                    scanner.close();
                    return;
            }
        }
    }

    /**
     * 从本地加载图书信息
     */
    @SuppressWarnings("unchecked")//忽略未经转换的问题信息
    public static void loadBooks(){
        File file = new File("data.txt");
        if(file.exists()){
            try(ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream("data.txt"))){
                LIST = (List<Book>) inputStream.readObject();
            }catch(IOException | ClassNotFoundException e){
                e.printStackTrace();
            }
        }else{
            LIST = new ArrayList<>();
        }
    }

    /**
     * 退出时保存现有的图书信息数据到本地
     */
    private static void saveBooks(){
        try(ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream("data.txt"))){
            outputStream.writeObject(LIST);
            outputStream.flush();
        }catch(IOException e){
            e.printStackTrace();
        }
    }

    /**
     * 从用户的输入中创建一个图书并插入，当价格为负数时，判断其不合理并不予插入
     * @param scanner
     * 用户输入信息
     */
    private static void insertBook(Scanner scanner){
        System.out.println("请输入想要插入的书本的信息：书名，作者，价格");
        Book book = new Book();
        book
                .name(scanner.nextLine())
                .author(scanner.nextLine());//链式构造book的成员变量
        double price = scanner.nextDouble();
        if(price < 0){
            System.out.println("错误的价格输入，本次插入失败，请重新输入");
        }else{
            book.price(price);
        }
        scanner.nextLine();
        LIST.add(book);
    }

    /**
     * 展示所有的图书列表，附带序号
     */
    private static void showBooks(){
        if(LIST.isEmpty()){
            System.out.println("无可显示图书信息");
        }else {
            LIST.sort((o1, o2) -> {
                return (int)(o1.price - o2.price);//按照作者名排序，将同一作者的书并列
            });
            int i = 0;
            for(Book book : LIST){
                i++;
                System.out.println(i + "." + book.toString());
            }
        }
    }

    /**
     * 修改某本图书的信息，需要用户输入图书的新序号以及各种新的信息
     * @param scanner
     * 用户输入信息
     */
    private static void modifyBook(Scanner scanner){
        int i = 0;
        for(Book book : LIST){
            i++;
            System.out.println(i + "." + book.toString());
        }
        System.out.println("请输入想要修改的书本的编号");
        int index = scanner.nextInt();
        scanner.nextLine();
        if(index > LIST.size()){
            System.out.println("错误的输入序号");
        }else {
            System.out.println("请输入想要修改的书本的信息：\r\n1.书名\r\n2.作者\r\n3.价格\r\n4.完全修改所有信息\r\n（按任意键退出修改）");
            int flag;
            flag = scanner.nextInt();
            scanner.nextLine();
            switch(flag){
                case(1):
                    System.out.println("请输入新的图书名字");
                    LIST.get(index - 1).name(scanner.nextLine());
                    break;
                case(2):
                    System.out.println("请输入新的作者名字");
                    LIST.get(index - 1).author(scanner.nextLine());
                    break;
                case(3):
                    System.out.println("请输入新的价格信息");
                    LIST.get(index - 1).price(scanner.nextDouble());
                    scanner.nextLine();
                    break;
                case(4):
                    System.out.println("请输入书本的全新信息：书名、作者名、价格");
                    LIST.get(index - 1).name(scanner.nextLine()).author(scanner.nextLine()).price(scanner.nextDouble());
                    scanner.nextLine();
                    break;
            }
        }
    }

    /**
     * 删除书本信息，要求给出书本的编号
     * @param scanner
     * 用户输入信息
     */
    private static void deleteBook(Scanner scanner){

        int i = 0;
        for(Book book : LIST){
            i++;
            System.out.println(i + "." + book.toString());
        }
        System.out.println("请输入想要删除的书本的编号");
        int index = scanner.nextInt();
        if(index > LIST.size()){
            System.out.println("错误的输入序号");
        }else LIST.remove(index - 1);
        scanner.nextLine();
    }

    /**
     * 定义一个书本类，支持序列化，以便于保存到文本中
     */
    private static class Book implements Serializable{
        String name;
        String author;
        double price;
        //方便我们对书籍的每一部分信息进行修改以及链式调用
        public Book name(String name) {
            this.name = name;
            return this;
        }
        public Book author(String author){
            this.author = author;
            return this;
        }
        public Book price(Double price){
            this.price = price;
            return this;
        }
        //重写toString方法，方便打印时打印出我们想要的信息
        public String toString(){
            return "书籍{" +
                    "名称 = '" + name +'\'' +
                    "，作者 = '" + author + '\'' +
                    "，价格 = '" + price + '\'' +
                    "}";
        }
    }
}
